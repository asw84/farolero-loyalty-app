# VK OAuth Setup –¥–ª—è —Å–æ—Ü–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Farolero

## üéØ –¶–µ–ª—å
VK –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –∞ –¥–ª—è —Å–æ—Ü–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
- –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö (–ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ä–µ–ø–æ—Å—Ç—ã, –ø–æ–¥–ø–∏—Å–∫–∏)
- –ü—Ä–∏–≤—è–∑–∫–∞ VK-–∞–∫–∫–∞—É–Ω—Ç–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±–æ—Ç–∞ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π

## üõ† –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Backend

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `backend/.env`:

```env
# VK OAuth Configuration
VK_CLIENT_ID=54020028
VK_CLIENT_SECRET=–í–ê–®_–ó–ê–©–ò–©–Å–ù–ù–´–ô_–ö–õ–Æ–ß_–ò–ó_VK
VK_REDIRECT_URI=https://api.5425685-au70735.twc1.net/api/oauth/vk/callback

# VK Group Configuration (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ)
VK_GROUP_ID=ID_–°–û–û–ë–©–ï–°–¢–í–ê_–ë–ï–ó_- (–Ω–∞–ø—Ä–∏–º–µ—Ä 227733445)
VK_GROUP_TOKEN=–ì–†–£–ü–ü–û–í–û–ô_–¢–û–ö–ï–ù_–°_–ü–†–ê–í–ê–ú–ò wall,groups,offline

# JWT Configuration
JWT_SECRET=supersecretjwt

# App Configuration
APP_BASE_URL=https://api.5425685-au70735.twc1.net
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ VK Group Token
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [VK Developer Console](https://vk.com/dev)
2. –°–æ–∑–¥–∞–π—Ç–µ Standalone-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —Å –ø—Ä–∞–≤–∞–º–∏: `wall`, `groups`, `offline`
4. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `VK_GROUP_TOKEN`

## üöÄ API Endpoints

### VK Login (–Ω–∞—á–∞–ª–æ OAuth)
```
GET /auth/vk/login?tg_user_id=TELEGRAM_USER_ID
```
- –°–æ–∑–¥–∞–µ—Ç JWT state —Å Telegram ID
- –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ VK OAuth

### OAuth Callback
```
GET /api/oauth/vk/callback?code=CODE_FROM_VK&state=JWT_STATE
```
- –ü–æ–ª—É—á–∞–µ—Ç `code` –∏ `state` –æ—Ç VK
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç JWT state
- –û–±–º–µ–Ω–∏–≤–∞–µ—Ç `code` –Ω–∞ `user_id`
- –°–≤—è–∑—ã–≤–∞–µ—Ç VK ID —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º –≤ AmoCRM
- –†–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ miniapp —Å `vk_id`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
```
POST /api/social/vk/verify
```
Body:
```json
{
  "action": "subscribe|like|comment|repost",
  "target": {
    "ownerId": -GROUP_ID,
    "postId": 123
  },
  "user": {
    "contactId": 456,
    "vkId": 789
  }
}
```

## üí∞ –°–∏—Å—Ç–µ–º–∞ –±–∞–ª–ª–æ–≤

| –î–µ–π—Å—Ç–≤–∏–µ | –ë–∞–ª–ª—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| `subscribe` | +20 | –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ |
| `social_like` | +2 | –õ–∞–π–∫ –ø–æ—Å—Ç–∞ |
| `social_comment` | +5 | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–æ—Å—Ç—É |
| `social_repost` | +10 | –†–µ–ø–æ—Å—Ç –ø–æ—Å—Ç–∞ |

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AmoCRM

### ‚úÖ –°–≤—è–∑–∞—Ç—å VK ID —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
```javascript
// –í backend/routes/oauth.js
const contactId = await amocrm.findByTelegramId(tg_user_id);
await amocrm.setCustomField(contactId, 'VK_ID_FIELD_ID', user_id);
```

### TODO: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
```javascript
// –í backend/services/loyaltyService.js
const currentPoints = await amocrm.getPoints(contactId);
const newPoints = currentPoints + points;
await amocrm.updatePoints(contactId, newPoints);
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–∏–≤—è–∑–∫–∞ VK –∞–∫–∫–∞—É–Ω—Ç–∞
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–≤—è–∑–∞—Ç—å VK —á–µ—Ä–µ–∑ OAuth"
3. –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—Å—Ç JWT state —Å –≤–∞—à–∏–º Telegram ID
4. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ VK OAuth —Å –∑–∞—â–∏—â–µ–Ω–Ω—ã–º state
5. –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ VK –≤–µ—Ä–Ω–µ—Ç code + state
6. Backend –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç state –∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç VK ID —Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
7. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ miniapp —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –ø—Ä–∏–≤—è–∑–∫–∏

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ VK —Å–æ–æ–±—â–µ—Å—Ç–≤–µ (–ª–∞–π–∫, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —Ä–µ–ø–æ—Å—Ç)
2. –ù–∞–∂–º–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã

## üì± Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### VKIDAuth.tsx
- –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ VK —á–µ—Ä–µ–∑ OAuth
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å VK ID SDK
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π `/auth/vk/login` —Ä–æ—É—Ç

### VKActions.tsx
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∞–π–∫–æ–≤/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤/—Ä–µ–ø–æ—Å—Ç–æ–≤
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –±–∞–ª–ª–æ–≤
- –†–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üîê –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### backend/routes/auth.js
- –°–æ–∑–¥–∞–Ω–∏–µ JWT state –¥–ª—è VK OAuth
- –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫
- –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ VK —Å –∑–∞—â–∏—â–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–ù–ï —Ö—Ä–∞–Ω–∏–º** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ `access_token` –Ω–∞ backend
- –ò—Å–ø–æ–ª—å–∑—É–µ–º JWT state –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF –∞—Ç–∞–∫
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –≥—Ä—É–ø–ø–æ–≤–æ–π —Ç–æ–∫–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ AmoCRM
- OAuth –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `vk_user_id`
- Telegram ID –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω—ã–π JWT state

## üö® –õ–∏–º–∏—Ç—ã VK API

- **–ó–∞–ø—Ä–æ—Å—ã –≤ —Å–µ–∫—É–Ω–¥—É**: 3
- **–ó–∞–ø—Ä–æ—Å—ã –≤ –¥–µ–Ω—å**: 1000
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ 5-10 –º–∏–Ω—É—Ç

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å VK –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å JWT state –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å AmoCRM –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è VK ID
5. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
6. üîÑ –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (middleware)
7. üîÑ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ VK API –∑–∞–ø—Ä–æ—Å–æ–≤
8. üîÑ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –∏ –±–∞–ª–ª–æ–≤

## üÜò Troubleshooting

### –û—à–∏–±–∫–∞ "oauth_vk_failed"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `VK_APP_ID` –∏ `VK_APP_SECRET`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `VK_REDIRECT_URI` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≤ VK

### –û—à–∏–±–∫–∞ "vk_verify_failed"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `VK_GROUP_TOKEN` –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `VK_GROUP_ID` —É–∫–∞–∑–∞–Ω –±–µ–∑ –º–∏–Ω—É—Å–∞

### –î–µ–π—Å—Ç–≤–∏—è –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `postId`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
