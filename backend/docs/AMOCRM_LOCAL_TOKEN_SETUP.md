# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ AmoCRM –ª–æ–∫–∞–ª—å–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–±–æ—á–∏–µ —Ç–æ–∫–µ–Ω—ã AmoCRM –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å —á–µ—Ä–µ–∑ redirect –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è localhost.

## –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥—ã
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
2. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª `backend/tokens.json` (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –í —Ñ–∞–π–ª–µ `backend/.env` —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
   ```
   AMOCRM_REDIRECT_URI=http://localhost:3001/api/amocrm/callback
   TOKENS_PATH=./app/tokens
   ```
4. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤:
   ```bash
   mkdir -p app/tokens
   ```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AmoCRM
1. –û—Ç–∫—Ä–æ–π—Ç–µ AmoCRM –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí –°–æ–∑–¥–∞–Ω–Ω—ã–µ –≤–∞–º–∏
3. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
4. –ù–∞ –≤–∫–ª–∞–¥–∫–µ "–ö–ª—é—á–∏ –∏ –¥–æ—Å—Ç—É–ø—ã" –≤ –ø–æ–ª–µ "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è" –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–ø–∏—à–∏—Ç–µ:
   ```
   http://localhost:3001/api/amocrm/callback
   ```
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
6. **–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ù–û–í–´–ô –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** (‚ö†Ô∏è –î–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ 10 –º–∏–Ω—É—Ç!)
7. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
–í —Ñ–∞–π–ª–µ `backend/amocrm/amocrm.json` –≤—Å—Ç–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥:
```json
{
  "base_url": "https://your-domain.amocrm.ru",
  "client_id": "your-client-id",
  "client_secret": "your-client-secret",
  "auth_code": "–í–°–¢–ê–í–¨–¢–ï_–ù–û–í–´–ô_–ö–û–î_–°–Æ–î–ê",
  "redirect_uri": "http://localhost:3001/api/amocrm/callback"
}
```

### –®–∞–≥ 4: –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
–í —Ñ–∞–π–ª–µ `backend/controllers/amocrm.controller.js` –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `init`:
```javascript
const init = async (req, res) => {
    try {
        await amocrmClient.getInitialToken();
        res.send('–¢–æ–∫–µ–Ω—ã AmoCRM —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã. –≠–Ω–¥–ø–æ–∏–Ω—Ç –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.');
    } catch (error) {
        console.error('‚ùå [AMOCRM_INIT_CONTROLLER] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ getInitialToken:', error);
        res.status(500).send('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –±—ç–∫–µ–Ω–¥–∞.');
    }
};
```

### –®–∞–≥ 5: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ backend –ª–æ–∫–∞–ª—å–Ω–æ:
   ```bash
   cd backend
   npm start
   ```
2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
   ```
   http://localhost:3001/api/amocrm/init
   ```
3. ‚úÖ –£—Å–ø–µ—Ö: –≤ –ø–∞–ø–∫–µ `app/tokens/` –ø–æ—è–≤–∏—Ç—Å—è —Ñ–∞–π–ª `tokens.json`

### –®–∞–≥ 6: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤–µ—Ä–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `init` –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –≤–∏–¥—É:
```javascript
const init = async (req, res) => {
    try {
        const authUrl = amocrmClient.getAuthUrl();
        res.redirect(authUrl);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ AmoCRM:', error);
        res.status(500).send('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    }
};
```

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
- ‚è∞ **–ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ 10 –º–∏–Ω—É—Ç!**
- üîÑ **–¢–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è** —Å –ø–æ–º–æ—â—å—é refresh_token
- üìÅ **–ü—É—Ç—å TOKENS_PATH** –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ä–µ–¥–µ (Docker vs localhost)
- üîÑ **–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤** –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

## –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
- `Authorization code has expired` - –ù—É–∂–µ–Ω –Ω–æ–≤—ã–π –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `TOKENS_PATH not found` - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ .env –∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É
- JSON syntax error - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø—è—Ç—ã–µ –≤ amocrm.json

## –†–µ–∑—É–ª—å—Ç–∞—Ç
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ —É –≤–∞—Å –±—É–¥–µ—Ç:
- –†–∞–±–æ—á–∏–π —Ñ–∞–π–ª `app/tokens/tokens.json` —Å access_token –∏ refresh_token
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
- –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AmoCRM
