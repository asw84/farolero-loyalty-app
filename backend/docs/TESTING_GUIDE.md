# üß™ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ü—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞–µ—Ç **4-—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:

### üîÑ –£—Ä–æ–≤–Ω–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **üîç Pre-deploy validation** - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
2. **üß™ Unit/API —Ç–µ—Å—Ç—ã** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
3. **üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤  
4. **üê≥ Docker –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
chmod +x test-deploy.sh
./test-deploy.sh
```

### –ü–æ—ç—Ç–∞–ø–Ω—ã–π –∑–∞–ø—É—Å–∫:
```bash
# 1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
bash scripts/pre-deploy-check.sh

# 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
node scripts/test-integrations.js

# 3. –ü–æ–ª–Ω–æ–µ Docker —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
bash scripts/test-complete.sh
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
‚îú‚îÄ‚îÄ test-deploy.sh                 # üéØ –ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ pre-deploy-check.sh        # ‚ö° –ë—ã—Å—Ç—Ä–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ test-complete.sh           # üê≥ –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ Docker —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ test-integrations.js       # üîó –¢–µ—Å—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ       ‚îú‚îÄ‚îÄ api.test.js            # üß™ API unit —Ç–µ—Å—Ç—ã
‚îÇ       ‚îî‚îÄ‚îÄ integrations.test.js   # üîó Jest –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îî‚îÄ‚îÄ test-results.json              # üìä –û—Ç—á–µ—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```

---

## üîç –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

### 1. **Pre-deploy Validation** (`scripts/pre-deploy-check.sh`)

**–¶–µ–ª—å:** –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (30 —Å–µ–∫)

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫—É Docker –∏ Docker Compose
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å docker-compose.yml
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–æ–≤

**–ó–∞–ø—É—Å–∫:**
```bash
bash scripts/pre-deploy-check.sh
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- `–ö–æ–¥ 0` - –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –¥–µ–ø–ª–æ–π
- `–ö–æ–¥ 1` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –¥–µ–ø–ª–æ–π –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω

---

### 2. **API Unit Tests** (`backend/tests/api.test.js`)

**–¶–µ–ª—å:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö API endpoints

**–ü–æ–∫—Ä—ã–≤–∞–µ—Ç:**
- ü©∫ Health checks
- üíæ Database operations  
- üë§ User management
- üéØ Referral system
- üìä Analytics & RFM
- üîê Authentication
- üõí Order processing
- ‚ùå Error handling
- ‚ö° Performance tests

**–ó–∞–ø—É—Å–∫:**
```bash
cd backend
npm run test:api
```

---

### 3. **Integration Tests** (`scripts/test-integrations.js`)

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

**–¢–µ—Å—Ç–∏—Ä—É–µ—Ç:**
- üè¢ **AmoCRM API** - –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- üîµ **VK API** - OAuth –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- üì∏ **Instagram API** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- üì± **Telegram Bot API** - –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
- üè† **Local Backend** - health check
- ‚öôÔ∏è **Environment Config** - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- üìÅ **File System** - –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤

**–ó–∞–ø—É—Å–∫:**
```bash
node scripts/test-integrations.js
```

**–û—Ç—á–µ—Ç:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `test-results.json`

---

### 4. **Docker Complete Testing** (`scripts/test-complete.sh`)

**–¶–µ–ª—å:** –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Docker –¥–µ–ø–ª–æ—è (5-10 –º–∏–Ω)

**–≠—Ç–∞–ø—ã:**
1. **üîç Environment Check** - –æ–∫—Ä—É–∂–µ–Ω–∏–µ
2. **üî® Build & Local Tests** - —Å–±–æ—Ä–∫–∞ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã  
3. **üê≥ Docker Testing** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
4. **üåê API Testing** - HTTP endpoints
5. **üîç Log Analysis** - –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤
6. **üè• Health Checks** - Docker health —Å—Ç–∞—Ç—É—Å
7. **üîÑ Integration Tests** - –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
8. **üíæ Persistence Tests** - volumes –∏ –¥–∞–Ω–Ω—ã–µ

**–ó–∞–ø—É—Å–∫:**
```bash
bash scripts/test-complete.sh
```

---

## üìä –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### ‚úÖ **–£—Å–ø–µ—à–Ω—ã–µ —Ç–µ—Å—Ç—ã (–ö–æ–¥ –≤—ã—Ö–æ–¥–∞: 0)**
- –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ production

### ‚ö†Ô∏è **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è**
- –ü—Ä–æ–µ–∫—Ç —É—Å–ª–æ–≤–Ω–æ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é
- –ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ API)
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ production

### ‚ùå **–û—à–∏–±–∫–∏ (–ö–æ–¥ –≤—ã—Ö–æ–¥–∞: 1)**
- –î–µ–ø–ª–æ–π –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –æ—à–∏–±–∫–∏

---

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CI/CD

### GitHub Actions –ø—Ä–∏–º–µ—Ä:

```yaml
name: Deploy Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run Pre-deploy Check
        run: bash scripts/pre-deploy-check.sh
      - name: Run Integration Tests  
        run: node scripts/test-integrations.js
      - name: Run Complete Docker Tests
        run: bash scripts/test-complete.sh
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤

### Environment Variables –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```env
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
AMOCRM_DOMAIN=your-domain.amocrm.ru
AMOCRM_CLIENT_ID=your-client-id
AMOCRM_CLIENT_SECRET=your-secret
VK_CLIENT_ID=your-vk-id
JWT_SECRET=your-jwt-secret

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ (–¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è)
TELEGRAM_BOT_TOKEN=your-bot-token
VK_CLIENT_SECRET=your-vk-secret
INSTAGRAM_APP_ID=your-insta-id
INSTAGRAM_APP_SECRET=your-insta-secret
```

### Jest Configuration:

```json
{
  "testEnvironment": "node",
  "testTimeout": 30000,
  "setupFilesAfterEnv": ["./tests/setup.js"]
}
```

---

## üö® Troubleshooting

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Docker –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**
   ```bash
   sudo systemctl start docker
   docker-compose down --remove-orphans
   ```

2. **–ü–æ—Ä—Ç—ã –∑–∞–Ω—è—Ç—ã**
   ```bash
   netstat -tuln | grep 3001
   docker-compose down
   ```

3. **–¢–µ—Å—Ç—ã API –ø–∞–¥–∞—é—Ç**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health check
   curl http://localhost:3001/health
   
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
   docker-compose logs backend
   ```

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
   cat backend/.env
   
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   ping api.vk.com
   ```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫:

```bash
# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
docker-compose down --remove-orphans --volumes
docker system prune -f

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞
docker-compose build --no-cache
docker-compose up -d
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

### –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:
- **API Tests:** ‚â• 95% success rate
- **Integration Tests:** ‚â• 90% success rate  
- **Docker Health:** 100% healthy
- **Response Time:** < 1000ms
- **Error Rate:** < 5%

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏: `docker-compose logs -f`
- Health checks: `curl http://localhost:3001/health`
- –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: `docker-compose ps`

---

## üéØ Best Practices

### –ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –¥–µ–ø–ª–æ–µ–º:
1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–µ `./test-deploy.sh`
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
3. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ production –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
4. ‚úÖ –°–¥–µ–ª–∞–π—Ç–µ backup –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –ø–ª–∞–Ω rollback

### –†–µ–≥—É–ª—è—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- **–ï–∂–µ–¥–Ω–µ–≤–Ω–æ:** `bash scripts/pre-deploy-check.sh`  
- **–ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º:** `./test-deploy.sh`
- **–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:** –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ unit —Ç–µ—Å—Ç—ã

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ production:
- Health checks –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** –¥–µ–ø–ª–æ—è –∏ **–±—ã—Å—Ç—Ä–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ** –ø—Ä–æ–±–ª–µ–º –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏! üöÄ
