# Инструкции по жесткому обновлению сервера до ветки final

## Обзор

Этот документ содержит инструкции по жесткому обновлению сервера до ветки `final` с использованием скрипта `deploy-final-branch.sh`.

## Что делает скрипт

Скрипт `deploy-final-branch.sh` выполняет следующие действия:

1. **Резервное копирование** всех критически важных файлов:
   - Файлы токенов (tokens.json)
   - Файлы окружения (.env)
   - Настройки AmoCRM (amocrm.json)
   - Токены из app/tokens
   - Настройки Qtickets (qtickets.json)
   - Базу данных SQLite (loyalty.db)
   - Постоянные данные (persistent_data)
   - Настройки Instagram (instagram.json)

2. **Обновление кода** из ветки `final`:
   - Выполняет `git fetch origin`
   - Выполняет `git reset --hard origin/final`

3. **Восстановление** всех сохраненных файлов

4. **Очистка** системы:
   - Останавливает все контейнеры
   - Удаляет все старые образы и контейнеры
   - Очищает тома Docker

5. **Пересборка и запуск** контейнеров:
   - Полная пересборка с новой версией
   - Запуск контейнеров с принудительным пересозданием

6. **Проверка** работоспособности всех сервисов

## Как выполнить скрипт на сервере

### Шаг 1: Подключитесь к серверу

```bash
ssh your_user@your_server_ip
```

### Шаг 2: Перейдите в директорию проекта

```bash
cd /var/www/farolero-loyalty-app
```

### Шаг 3: Сделайте скрипт исполняемым

```bash
chmod +x deploy-final-branch.sh
```

### Шаг 4: Запустите скрипт

```bash
./deploy-final-branch.sh
```

### Шаг 5: Дождитесь завершения

Скрипт выполнит все необходимые действия автоматически. Процесс может занять некоторое время (10-20 минут) в зависимости от скорости сервера и размера проекта.

## После выполнения скрипта

1. **Проверьте статус контейнеров**:
   ```bash
   docker-compose ps
   ```

2. **Проверьте логи**:
   ```bash
   docker-compose logs --tail=50
   ```

3. **Проверьте доступность приложения**:
   - Фронтенд: https://app.5425685-au70735.twc1.net
   - Бэкенд API: https://api.5425685-au70735.twc1.net

4. **Очистите кеш браузера**:
   - Нажмите Ctrl+F5 (Windows) или Cmd+Shift+R (Mac)
   - Или очистите кеш браузера вручную

## Возможные проблемы и их решение

### Проблема: Скрипт не может найти файлы

**Решение**: Убедитесь, что вы находитесь в правильной директории (`/var/www/farolero-loyalty-app`).

### Проблема: Ошибка прав доступа

**Решение**: Убедитесь, что у пользователя есть права на выполнение Docker-команд. Возможно, потребуется добавить пользователя в группу docker:

```bash
sudo usermod -aG docker $USER
```

После этого перелогиньтесь или выполните:

```bash
newgrp docker
```

### Проблема: Контейнеры не запускаются

**Решение**: Проверьте логи контейнеров:

```bash
docker-compose logs backend
docker-compose logs frontend
```

### Проблема: Приложение недоступно после обновления

**Решение**: 
1. Проверьте статус контейнеров: `docker-compose ps`
2. Проверьте логи: `docker-compose logs`
3. Очистите кеш браузера
4. Проверьте работу API эндпоинтов вручную

## Важные замечания

1. **Резервное копирование**: Скрипт автоматически создает резервные копии всех важных файлов перед обновлением.

2. **Жесткая очистка**: Скрипт удаляет ВСЕ Docker-образы и контейнеры, включая неиспользуемые. Это гарантирует чистую установку.

3. **Версия сборки**: Скрипт генерирует уникальную версию сборки для предотвращения проблем с кешированием.

4. **Проверка работоспособности**: Скрипт автоматически проверяет работоспособность всех основных API эндпоинтов после обновления.

## Альтернативный метод (ручное выполнение)

Если по какой-то причине скрипт не работает, вы можете выполнить все шаги вручную:

```bash
# 1. Перейдите в директорию проекта
cd /var/www/farolero-loyalty-app

# 2. Создайте директорию для бэкапа
mkdir -p /tmp/farolero-backup

# 3. Сохраните важные файлы (пример)
cp backend/tokens.json /tmp/farolero-backup/
cp backend/.env /tmp/farolero-backup/
cp frontend/.env /tmp/farolero-backup/
# ... и так далее для всех важных файлов

# 4. Обновите код из ветки final
git fetch origin
git reset --hard origin/final

# 5. Восстановите файлы
cp /tmp/farolero-backup/tokens.json backend/
cp /tmp/farolero-backup/backend/.env backend/
cp /tmp/farolero-backup/frontend/.env frontend/
# ... и так далее для всех сохраненных файлов

# 6. Остановите контейнеры
docker-compose down

# 7. Очистите систему
docker system prune -af
docker builder prune -af
docker volume prune -f

# 8. Пересоберите и запустите контейнеры
docker-compose build --no-cache
docker-compose up -d --force-recreate

# 9. Проверьте статус
docker-compose ps
docker-compose logs --tail=30
```

## Заключение

Следуя этим инструкциям, вы сможете жестко обновить сервер до ветки `final`, сохранив все важные данные и настройки. Скрипт `deploy-final-branch.sh` автоматизирует весь процесс и минимизирует риск ошибок.